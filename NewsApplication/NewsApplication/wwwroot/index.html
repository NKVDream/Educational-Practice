<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Новостное приложение</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            background-color: #f5f5f5;
            padding: 20px;
        }

        .header {
            background: linear-gradient(135deg, #007bff, #6610f2);
            color: white;
            padding: 30px 20px;
            border-radius: 10px;
            margin-bottom: 30px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .user-info {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

            .user-info button {
                background: #dc3545;
                color: white;
                border: none;
                padding: 8px 15px;
                border-radius: 4px;
                cursor: pointer;
            }

                .user-info button:hover {
                    background: #c82333;
                }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        h2 {
            margin: 25px 0 15px 0;
            color: #444;
            border-bottom: 2px solid #007bff;
            padding-bottom: 5px;
        }

        .articles-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 25px;
            margin-top: 20px;
        }

        .article-card {
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
            transition: transform 0.3s, box-shadow 0.3s;
        }

            .article-card:hover {
                transform: translateY(-5px);
                box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            }

        .article-image {
            width: 100%;
            height: 200px;
            object-fit: cover;
        }

        .article-content {
            padding: 20px;
        }

        .article-title {
            font-size: 1.4rem;
            margin-bottom: 10px;
            color: #007bff;
        }

        .article-excerpt {
            color: #666;
            margin-bottom: 15px;
            line-height: 1.5;
        }

        .article-meta {
            display: flex;
            justify-content: space-between;
            color: #888;
            font-size: 0.9rem;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #eee;
        }

        .article-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        button {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
            transition: background-color 0.2s;
        }

        .edit-btn {
            background-color: #28a745;
            color: white;
        }

            .edit-btn:hover {
                background-color: #218838;
            }

        .delete-btn {
            background-color: #dc3545;
            color: white;
        }

            .delete-btn:hover {
                background-color: #c82333;
            }

        .form-container {
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #555;
        }

        input, textarea, select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 1rem;
        }

        textarea {
            min-height: 150px;
            resize: vertical;
        }

        .form-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .submit-btn {
            background-color: #007bff;
            color: white;
            padding: 10px 20px;
        }

            .submit-btn:hover {
                background-color: #0056b3;
            }

        .cancel-btn {
            background-color: #6c757d;
            color: white;
            padding: 10px 20px;
        }

            .cancel-btn:hover {
                background-color: #545b62;
            }

        .message {
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
            display: none;
        }

        .success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Шапка -->
        <div class="header">
            <h1>📰 Новостное приложение</h1>
            <p>Самые свежие новости в одном месте</p>
        </div>

        <!-- Информация о пользователе -->
        <div class="user-info">
            <div id="user-greeting">Загрузка...</div>
            <button onclick="logout()">Выйти</button>
        </div>

        <!-- Форма создания/редактирования статьи -->
        <div id="article-form-container" class="form-container" style="display: none;">
            <h2 id="form-title">Создать новую статью</h2>
            <div id="message" class="message"></div>

            <form id="articleForm">
                <input type="hidden" id="articleId">

                <div class="form-group">
                    <label for="title">Заголовок *</label>
                    <input type="text" id="title" required maxlength="200">
                </div>

                <div class="form-group">
                    <label for="excerpt">Краткое описание</label>
                    <textarea id="excerpt" maxlength="500"></textarea>
                </div>

                <div class="form-group">
                    <label for="content">Содержание *</label>
                    <textarea id="content" required></textarea>
                </div>

                <div class="form-group">
                    <label for="cover_image_url">Ссылка на обложку</label>
                    <input type="url" id="cover_image_url" placeholder="https://example.com/image.jpg">
                </div>

                <div class="form-group">
                    <label for="category_id">Категория *</label>
                    <select id="category_id" required>
                        <option value="">Выберите категорию</option>
                        <!-- Категории загрузятся через JS -->
                    </select>
                </div>

                <div class="form-actions">
                    <button type="button" class="cancel-btn" onclick="hideForm()">Отмена</button>
                    <button type="submit" class="submit-btn">Сохранить</button>
                </div>
            </form>
        </div>

        <!-- Кнопка создания статьи -->
        <div id="create-button-container" style="text-align: right; margin-bottom: 20px;">
            <button class="submit-btn" onclick="showCreateForm()">+ Создать статью</button>
        </div>

        <!-- Список статей -->
        <h2>Последние новости</h2>
        <div id="loading" class="loading">
            Загрузка статей...
        </div>
        <div id="articles-container" class="articles-list">
            <!-- Статьи загрузятся через JS -->
        </div>
    </div>

    <script>
        // Глобальные переменные
        let currentUser = null;
        let categories = [];
        let articles = [];

        // Проверяем авторизацию при загрузке страницы
        document.addEventListener('DOMContentLoaded', function() {
            checkAuth();
            loadCategories();
            loadArticles();
        });

        function checkAuth() {
            const canView = localStorage.getItem('canView') === 'true';
            const username = localStorage.getItem('username');
            const role = localStorage.getItem('userRole');

            if (!canView || !username) {
                window.location.href = "login.html";
            } else {
                currentUser = {
                    username: username,
                    role: role,
                    canEdit: localStorage.getItem('canEdit') === 'true',
                    canDelete: localStorage.getItem('canDelete') === 'true'
                };

                updateUserInfo();
                setupUI();
            }
        }

        function updateUserInfo() {
            document.getElementById('user-greeting').innerHTML = `
                👤 <strong>${currentUser.username}</strong>
                <span style="color: #666;">(${currentUser.role})</span>
            `;
        }

        function setupUI() {
            // Показываем/скрываем кнопку создания
            const createBtnContainer = document.getElementById('create-button-container');
            if (!currentUser.canEdit) {
                createBtnContainer.style.display = 'none';
            }
        }

        async function loadCategories() {
            try {
                const response = await fetch('https://localhost:5001/api/Categories');
                if (response.ok) {
                    categories = await response.json();
                    updateCategorySelect();
                }
            } catch (error) {
                console.error('Ошибка загрузки категорий:', error);
            }
        }

        async function loadArticles() {
            try {
                const response = await fetch('https://localhost:5001/api/Articles');
                if (response.ok) {
                    articles = await response.json();
                    renderArticles();
                }
            } catch (error) {
                console.error('Ошибка загрузки статей:', error);
            } finally {
                document.getElementById('loading').style.display = 'none';
            }
        }

        function renderArticles() {
            const container = document.getElementById('articles-container');

            if (articles.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 40px; color: #666;">Нет статей для отображения</div>';
                return;
            }

            container.innerHTML = articles.map(article => `
                <div class="article-card">
                    ${article.cover_image_url ? `
                        <img src="${article.cover_image_url}" alt="${article.title}" class="article-image">
                    ` : ''}
                    <div class="article-content">
                        <h3 class="article-title">${article.title}</h3>
                        <p class="article-excerpt">${article.excerpt || article.content.substring(0, 150) + '...'}</p>

                        <div class="article-meta">
                            <div>
                                📅 ${new Date(article.published).toLocaleDateString('ru-RU')}
                            </div>
                            <div>
                                👤 ${article.author ? article.author.username : 'Неизвестный автор'}
                            </div>
                        </div>

                        <div class="article-actions">
                            <button onclick="viewArticle(${article.id})"
                                    style="background: #17a2b8; color: white;">Читать</button>

                            ${currentUser.canEdit ? `
                                <button onclick="editArticle(${article.id})" class="edit-btn">Редактировать</button>
                            ` : ''}

                            ${currentUser.canDelete ? `
                                <button onclick="deleteArticle(${article.id})" class="delete-btn">Удалить</button>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function updateCategorySelect() {
            const select = document.getElementById('category_id');
            select.innerHTML = '<option value="">Выберите категорию</option>' +
                categories.map(cat => `<option value="${cat.id}">${cat.name}</option>`).join('');
        }

        function showCreateForm() {
            document.getElementById('form-title').textContent = 'Создать новую статью';
            document.getElementById('articleForm').reset();
            document.getElementById('articleId').value = '';
            document.getElementById('article-form-container').style.display = 'block';
            document.getElementById('create-button-container').style.display = 'none';
            window.scrollTo(0, 0);
        }

        function hideForm() {
            document.getElementById('article-form-container').style.display = 'none';
            document.getElementById('create-button-container').style.display = 'block';
            document.getElementById('message').style.display = 'none';
        }

        async function editArticle(id) {
            const article = articles.find(a => a.id === id);
            if (!article) return;

            document.getElementById('form-title').textContent = 'Редактировать статью';
            document.getElementById('articleId').value = article.id;
            document.getElementById('title').value = article.title;
            document.getElementById('excerpt').value = article.excerpt || '';
            document.getElementById('content').value = article.content;
            document.getElementById('cover_image_url').value = article.cover_image_url || '';
            document.getElementById('category_id').value = article.category_id;

            document.getElementById('article-form-container').style.display = 'block';
            document.getElementById('create-button-container').style.display = 'none';
            window.scrollTo(0, 0);
        }

        function viewArticle(id) {
            alert(`Просмотр статьи ${id} - можно реализовать отдельную страницу`);
        }

        // Обработка формы
        document.getElementById('articleForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const articleId = document.getElementById('articleId').value;
            const isEdit = !!articleId;

            const articleData = {
                title: document.getElementById('title').value,
                excerpt: document.getElementById('excerpt').value,
                content: document.getElementById('content').value,
                cover_image_url: document.getElementById('cover_image_url').value,
                category_id: parseInt(document.getElementById('category_id').value),
                author_id: 1 // Здесь нужно получить ID текущего пользователя из БД
            };

            try {
                let response;
                if (isEdit) {
                    articleData.id = parseInt(articleId);
                    response = await fetch(`https://localhost:5001/api/Articles/${articleId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(articleData)
                    });
                } else {
                    response = await fetch('https://localhost:5001/api/Articles', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(articleData)
                    });
                }

                if (response.ok) {
                    showMessage('Статья успешно сохранена!', 'success');
                    await loadArticles();
                    setTimeout(hideForm, 1500);
                } else {
                    const error = await response.text();
                    showMessage(`Ошибка: ${error}`, 'error');
                }
            } catch (error) {
                showMessage('Ошибка сети', 'error');
            }
        });

        async function deleteArticle(id) {
            if (!confirm('Вы уверены, что хотите удалить эту статью?')) return;

            try {
                const response = await fetch(`https://localhost:5001/api/Articles/${id}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    showMessage('Статья удалена!', 'success');
                    await loadArticles();
                } else {
                    showMessage('Ошибка удаления', 'error');
                }
            } catch (error) {
                showMessage('Ошибка сети', 'error');
            }
        }

        function showMessage(text, type) {
            const messageDiv = document.getElementById('message');
            messageDiv.textContent = text;
            messageDiv.className = `message ${type}`;
            messageDiv.style.display = 'block';

            if (type === 'success') {
                setTimeout(() => {
                    messageDiv.style.display = 'none';
                }, 3000);
            }
        }

        function logout() {
            localStorage.clear();
            window.location.href = "login.html";
        }
    </script>
</body>
</html>